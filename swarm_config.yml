---
- hosts: all
  roles:
    - role: docker-photon-config
      when: ansible_lsb.codename == 'Photon'
  post_tasks:
    - name: ensure docker daemon started
      systemd: state=started name=docker

# - hosts: localhost
  # vars:
    # vagrant_mc_name: foo
    # ansible_sudo_pass: q
- hosts: bootstrap
  roles:
    - role: docker-ca
      when: docker_connect_secure

- hosts: 
    - bootstrap
    - masters
  roles:
    - role: docker-cs-requestor
      when: docker_connect_secure
    - role: docker-remote-cert-holder
      vars:
        docker_ca_host: "{{ groups['bootstrap'][0] }}" # or localhost
      when: docker_connect_secure
    - role: docker-remote-connectable
      when: ansible_lsb.codename == 'Photon'
  
- hosts: bootstrap
  roles:
    - role: docker-swarm-bootstrap
      register: tokens
  tasks:
    - name: set tokens as facts
      set_fact:
        "token_{{ item.item }}": "{{ item.stdout }}"
      with_items: "{{ tokens.results }}"

- hosts: 
    - masters
    - nodes
  vars:
    token_mapping:
      masters: manager
      nodes: worker
    token_key: "token_{{ token_mapping[group_names[0]] }}"
  roles:
    - role: docker-swarm-member
      vars:
        swarm_token: "{{ hostvars[groups['bootstrap'][0]][token_key] }}"
        swarm_master: "{{ hostvars[groups['bootstrap'][0]]['ansible_ipv4']['address'] }}"
